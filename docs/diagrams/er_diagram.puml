@startuml er_diagram

title Connect Four Database - Entity Relationship Diagram

skinparam linetype ortho

entity "users" as users {
    * user_id : INTEGER <<PK>>
    --
    * username : VARCHAR(50) <<unique>>
    * password_hash : VARCHAR(255)
    * rating : INTEGER = 1000
    * wins : INTEGER = 0
    * losses : INTEGER = 0
    * draws : INTEGER = 0
    * created_at : TIMESTAMP
    * last_login : TIMESTAMP
}

entity "game_records" as games {
    * game_id : INTEGER <<PK>>
    --
    * player1_id : INTEGER <<FK>>
    * player2_id : INTEGER <<FK>>
    winner_id : INTEGER <<FK>> <<nullable>>
    * game_type : VARCHAR(20)
    * moves : TEXT
    * total_moves : INTEGER
    * duration_ms : INTEGER
    * played_at : TIMESTAMP
}

entity "active_rooms" as rooms {
    * room_id : VARCHAR(10) <<PK>>
    --
    * host_id : INTEGER <<FK>>
    guest_id : INTEGER <<FK>> <<nullable>>
    * status : VARCHAR(20)
    * game_state : TEXT
    * created_at : TIMESTAMP
    * updated_at : TIMESTAMP
}

entity "elo_history" as elo {
    * history_id : INTEGER <<PK>>
    --
    * user_id : INTEGER <<FK>>
    * game_id : INTEGER <<FK>>
    * rating_before : INTEGER
    * rating_after : INTEGER
    * rating_change : INTEGER
    * recorded_at : TIMESTAMP
}

entity "spectators" as spectators {
    * spectator_id : INTEGER <<PK>>
    --
    * room_id : VARCHAR(10) <<FK>>
    * user_id : INTEGER <<FK>>
    * joined_at : TIMESTAMP
}

' Relationships

users ||--o{ games : "plays as player1"
users ||--o{ games : "plays as player2"
users ||--o| games : "wins"

users ||--o{ rooms : "hosts"
users ||--o{ rooms : "joins as guest"

users ||--o{ elo : "has rating history"
games ||--o{ elo : "generates"

rooms ||--o{ spectators : "has"
users ||--o{ spectators : "watches"

note right of users
    **Indexes:**
    - username (unique)
    - rating (for leaderboard)
    
    **ELO System:**
    - Initial rating: 1000
    - K-factor: 30
    - Win/Loss: Â±15 typical
end note

note right of games
    **game_type values:**
    - 'pvp' (player vs player)
    - 'ai_easy' (depth 2)
    - 'ai_medium' (depth 4)
    - 'ai_hard' (depth 6)
    
    **moves format:**
    "3,3,4,2,5,1,6" (column sequence)
end note

note right of rooms
    **status values:**
    - 'WAITING'
    - 'PLAYING'
    - 'FINISHED'
    
    **game_state:**
    JSON serialized bitboard
end note

@enduml
